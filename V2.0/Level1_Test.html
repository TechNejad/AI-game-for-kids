<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xeno-Ecology Simulation - Level 1</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script type="module">
        // This allows the Groq SDK to run in a browser environment.
        window.process = { env: { GROQ_API_KEY: "nope" } };
    </script>
    <style>
        body {
            background-color: #1a1a1a;
            color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: 'Roboto Mono', monospace;
        }
        .game-console-body {
            background: linear-gradient(145deg, #3c3c3c, #1e1e1e);
            border-radius: 30px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: center;
            border: 2px solid #111;
            width: 100%;
            max-width: 900px;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.7), 0 10px 30px rgba(0,0,0,0.5);
        }
        #canvas-header {
            color: #aaa;
            font-size: 1.2rem;
            font-weight: bold;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        #game-canvas {
            border: 2px solid #4a4a4a;
            border-radius: 8px;
            width: 100%;
            max-width: 800px;
            height: auto;
            aspect-ratio: 1 / 1;
            background-color: #000;
        }
    </style>
</head>
<body>

    <div class="game-console-body">
        <div id="canvas-header">XENO-ECOLOGY LAB // CHRONO-BLOOM EXAM</div>
        <canvas id="game-canvas" width="800" height="800"></canvas>
    </div>

    <script type="module">
        import Groq from "https://esm.sh/groq-sdk";

        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');

        // --- API Configuration ---
        const API_KEY = "nope"; // IMPORTANT: Replace with your Groq API key
        let groq;

        // --- Character Configuration ---
        const PLAYER_SPEED = 1; // Control player movement speed
        const PLAYER_DISPLAY_WIDTH = 50; // Control the character's rendered width
        const PLAYER_DISPLAY_HEIGHT = 74; // Control the character's rendered height
        
        const RATIO_DISPLAY_WIDTH = 35;  // Control Ratio's rendered width
        const RATIO_DISPLAY_HEIGHT = 37; // Control Ratio's rendered height

        // --- Game State and Configuration ---
        const gameState = {
            player: { 
                x: 385, 
                y: 700, 
                spriteWidth: 164, 
                spriteHeight: 243,
                width: PLAYER_DISPLAY_WIDTH, 
                height: PLAYER_DISPLAY_HEIGHT,
                frameX: 0, 
                frameY: 0, 
                speed: PLAYER_SPEED, 
                moving: false 
            },
            ratio: { 
                x: 385, 
                y: 750, 
                width: RATIO_DISPLAY_WIDTH, 
                height: RATIO_DISPLAY_HEIGHT, 
                speed: 2.8, 
                followDistance: 80,
                direction: 'right' // Can be 'left' or 'right'
            },
            keys: { w: false, a: false, s: false, d: false },
            collectedComponents: {
                stabilizer: false,
                nutrients: false,
                light: false
            },
            isTaskComplete: false,
            inPromptBuilderMode: false,
            nearbyObject: null,
            isAiThinking: false,
            groundskeeperDialogueHistory: [],
            activeDialogue: {
                isActive: false,
                speaker: null,
                text: '',
                displayText: '',
                charIndex: 0,
                options: [],
                selectedOption: 0
            }
        };

        // --- Map Components ---
        const interactables = [
            { id: 'plant', name: 'Chrono-Bloom', x: 360, y: 360, width: 80, height: 80, color: 'rgba(255, 0, 255, 0.5)' },
            { id: 'stabilizer', name: 'Temporal Stabilizer', x: 130, y: 150, width: 100, height: 50, color: 'rgba(0, 255, 255, 0.5)' },
            { id: 'nutrients', name: 'Nutrient Synthesizer', x: 570, y: 150, width: 100, height: 50, color: 'rgba(65, 105, 225, 0.5)' },
            { id: 'light', name: 'Lunar Lamp', x: 80, y: 400, width: 50, height: 80, color: 'rgba(255, 255, 0, 0.5)' },
            { id: 'groundskeeper', name: 'BOT-ANY 5000', x: 550, y: 650, width: 40, height: 60, color: 'rgba(128, 128, 128, 0.7)' },
            { id: 'exit', name: 'Exit Door', x: 375, y: 190, width: 50, height: 20, color: 'rgba(255, 69, 0, 0.7)' }
        ];

        // --- Asset Loading ---
        const backgroundImage = new Image();
        const playerImage = new Image();
        const ratioImageR = new Image();
        const ratioImageL = new Image();
        
        backgroundImage.src = 'assets/level1_ecology/ecology_background.png';
        playerImage.src = 'assets/start/walking_character_Finn.png';
        ratioImageR.src = 'assets/start/Ratio_R.png';
        ratioImageL.src = 'assets/start/Ratio_L.png';


        // --- AI Persona ---
        const groundskeeperPersona = {
            systemPrompt: `You are BOT-ANY 5000, a sarcastic, rustic groundskeeper-bot. You give helpful but flavorful hints. Keep responses to 2-3 short sentences. You are talking to a student, the 'Cadet'.`
        };

        // --- Dialogue System ---
        function startDialogue(speaker, text, options = []) {
            const { activeDialogue } = gameState;
            activeDialogue.isActive = true;
            activeDialogue.speaker = speaker;
            activeDialogue.text = text;
            activeDialogue.displayText = '';
            activeDialogue.charIndex = 0;
            activeDialogue.options = options;
            activeDialogue.selectedOption = 0;
        }

        function closeDialogue() {
            gameState.activeDialogue.isActive = false;
        }

        async function getAiDialogue(userChoice) {
            if (gameState.isAiThinking || !groq) return;
            gameState.isAiThinking = true;
            startDialogue("BOT-ANY 5000", "Thinking...");

            const messages = [
                { role: "system", content: groundskeeperPersona.systemPrompt },
                ...gameState.groundskeeperDialogueHistory,
                { role: "user", content: userChoice }
            ];
            
            try {
                const stream = await groq.chat.completions.create({ messages, model: 'llama-3.1-8b-instant', stream: true });
                let fullResponse = "";
                gameState.activeDialogue.text = ""; // Clear "Thinking..."
                for await (const chunk of stream) {
                    const content = chunk.choices[0]?.delta?.content || "";
                    fullResponse += content;
                    gameState.activeDialogue.text = fullResponse; // Update text as it streams
                }
                gameState.groundskeeperDialogueHistory.push({ role: 'user', content: userChoice });
                gameState.groundskeeperDialogueHistory.push({ role: 'assistant', content: fullResponse });
            } catch (error) {
                console.error("Groq API Error:", error);
                startDialogue("System", "Error connecting to BOT-ANY 5000's processors.");
            } finally {
                gameState.isAiThinking = false;
            }
        }
        
        function getRatioHint() {
            const { collectedComponents, isTaskComplete } = gameState;
            let hint = "";
            if (isTaskComplete) {
                hint = "Splendid work, Cadet! The plant is stable. Let's head for the exit.";
            } else if (collectedComponents.stabilizer && collectedComponents.nutrients && collectedComponents.light) {
                hint = "We have all the components! Time to use them on that strange-looking plant.";
            } else if (!collectedComponents.stabilizer) {
                hint = "That blue station looks important. It might be the Temporal Stabilizer we need.";
            } else if (!collectedComponents.nutrients) {
                hint = "I believe the Nutrient Synthesizer is that other station in the upper corner.";
            } else if (!collectedComponents.light) {
                hint = "Don't forget the Lunar Lamp over there on the left wall.";
            } else {
                hint = "Let's get to it, Cadet. Collect those components!";
            }
            startDialogue("Ratio", hint);
        }

        function triggerRatioComment(eventType) {
             let comment = "";
             switch(eventType) {
                case 'COLLECT_STABILIZER': comment = "Excellent! One component down."; break;
                case 'COLLECT_NUTRIENTS': comment = "Good, the nutrient solution is ours."; break;
                case 'COLLECT_LIGHT': comment = "Perfect. We have the Lunar-Cycle component."; break;
             }
             if (comment) startDialogue("Ratio", comment);
        }

        function triggerDialogue(characterId) {
            if (characterId === 'groundskeeper') {
                startDialogue("BOT-ANY 5000", "Well, Cadet? What do you need?", [
                    { text: "Ask about the Chrono-Bloom.", action: () => getAiDialogue("Tell me about this Chrono-Bloom.") },
                    { text: "Ask for a hint.", action: () => getAiDialogue("I'm a bit stuck, can you give me a hint?") },
                    { text: "Goodbye.", action: closeDialogue }
                ]);
            } else if (characterId === 'ratio') {
                getRatioHint();
            }
        }
        
        function handleInteraction() {
            if (!gameState.nearbyObject || gameState.isAiThinking || gameState.inPromptBuilderMode || gameState.activeDialogue.isActive) return;
            const { id } = gameState.nearbyObject;
            if (id === 'groundskeeper' || id === 'ratio') {
                triggerDialogue(id);
                return;
            }
            let interactionMessage = "";
            switch(id) {
                case 'stabilizer':
                    if (!gameState.collectedComponents.stabilizer) {
                        gameState.collectedComponents.stabilizer = true;
                        triggerRatioComment('COLLECT_STABILIZER');
                    } else { startDialogue("System", "You already have this component."); }
                    break;
                case 'nutrients':
                    if (!gameState.collectedComponents.nutrients) {
                        gameState.collectedComponents.nutrients = true;
                        triggerRatioComment('COLLECT_NUTRIENTS');
                    } else { startDialogue("System", "You already have this component."); }
                    break;
                case 'light':
                    if (!gameState.collectedComponents.light) {
                        gameState.collectedComponents.light = true;
                        triggerRatioComment('COLLECT_LIGHT');
                    } else { startDialogue("System", "You already have this component."); }
                    break;
                case 'plant':
                    const { stabilizer, nutrients, light } = gameState.collectedComponents;
                    if (stabilizer && nutrients && light) {
                        if (!gameState.isTaskComplete) { gameState.inPromptBuilderMode = true; } 
                        else { startDialogue("System", "The Chrono-Bloom is already stable."); }
                    } else { startDialogue("System", "Components missing. Cannot upload prompt."); }
                    break;
                case 'exit':
                    if (gameState.isTaskComplete) {
                         alert("Congratulations! Exam Complete!");
                         location.reload(); 
                    } else { startDialogue("System", "Door is locked. Stabilize the Chrono-Bloom first."); }
                    break;
            }
        }
        
        // --- Keyboard Input Handling ---
        window.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase();
            if (gameState.activeDialogue.isActive) {
                const { activeDialogue } = gameState;
                if (key === 'w' || key === 'arrowup') {
                    activeDialogue.selectedOption = (activeDialogue.selectedOption - 1 + activeDialogue.options.length) % activeDialogue.options.length;
                } else if (key === 's' || key === 'arrowdown') {
                    activeDialogue.selectedOption = (activeDialogue.selectedOption + 1) % activeDialogue.options.length;
                } else if (key === 'e' || key === 'enter') {
                    if (activeDialogue.charIndex < activeDialogue.text.length) {
                        activeDialogue.charIndex = activeDialogue.text.length; // Skip typewriter
                    } else if (activeDialogue.options.length > 0) {
                        activeDialogue.options[activeDialogue.selectedOption].action();
                    } else {
                        closeDialogue();
                    }
                }
                return;
            }

            if (gameState.inPromptBuilderMode && e.key === 'Enter') {
                gameState.inPromptBuilderMode = false;
                gameState.isTaskComplete = true;
                startDialogue("System", "Prompt uploaded! Chrono-Bloom is stable.");
                return;
            }
            if (gameState.keys.hasOwnProperty(key)) {
                gameState.keys[key] = true;
                gameState.player.moving = true;
            }
            if (key === 'e') handleInteraction();
        });

        window.addEventListener('keyup', (e) => {
            const key = e.key.toLowerCase();
            if (gameState.keys.hasOwnProperty(key)) {
                gameState.keys[key] = false;
            }
             if (!gameState.keys.w && !gameState.keys.a && !gameState.keys.s && !gameState.keys.d) {
                gameState.player.moving = false;
            }
        });
        
        // --- Collision Logic ---
        function checkCollision(rectA, rectB) {
            const buffer = 15; 
            return rectA.x < rectB.x + rectB.width + buffer && rectA.x + rectA.width + buffer > rectB.x &&
                   rectA.y < rectB.y + rectB.height + buffer && rectA.y + rectA.height + buffer > rectB.y;
        }

        // --- Game Loop ---
        function update() {
            if (gameState.inPromptBuilderMode || gameState.activeDialogue.isActive) return;
            
            // Player Movement
            const { player, ratio, keys } = gameState;
            if (keys.w) { player.y -= player.speed; player.frameY = 3; }
            if (keys.s) { player.y += player.speed; player.frameY = 0; }
            if (keys.a) { player.x -= player.speed; player.frameY = 2; ratio.direction = 'left'; }
            if (keys.d) { player.x += player.speed; player.frameY = 1; ratio.direction = 'right'; }

            // Screen Bounds
            player.x = Math.max(0, Math.min(canvas.width - player.width, player.x));
            player.y = Math.max(0, Math.min(canvas.height - player.height, player.y));
            
            // Ratio Follow Logic
            const dx = player.x - ratio.x;
            const dy = player.y - ratio.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            if (distance > ratio.followDistance) {
                ratio.x += (dx / distance) * ratio.speed;
                ratio.y += (dy / distance) * ratio.speed;
            }
            
            // Interaction Check
            gameState.nearbyObject = null;
            for (const obj of interactables) {
                if (checkCollision(player, obj)) { gameState.nearbyObject = obj; return; }
            }
            if (checkCollision(player, ratio)) {
                 gameState.nearbyObject = { id: 'ratio', name: 'Ratio', ...ratio };
            }
        }
        
        // --- Animation Handling ---
        let frameCounter = 0;
        const animationSpeed = 8; // Update frame every 8 game loops

        function handlePlayerAnimation() {
            if (gameState.player.moving) {
                frameCounter++;
                if (frameCounter >= animationSpeed) {
                    frameCounter = 0;
                    gameState.player.frameX = (gameState.player.frameX + 1) % 4;
                }
            } else {
                gameState.player.frameX = 0;
            }
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // Draw background first
            if (backgroundImage.complete && backgroundImage.naturalWidth !== 0) { 
                ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height); 
            } else { 
                ctx.fillStyle = '#000'; ctx.fillRect(0, 0, canvas.width, canvas.height); 
            }
            
            interactables.forEach(obj => {
                let color = obj.color;
                if (obj.id === 'exit' && gameState.isTaskComplete) color = 'rgba(0, 255, 127, 0.7)';
                if (obj.id === 'plant' && !gameState.isTaskComplete) {
                    const pulse = Math.abs(Math.sin(Date.now() * 0.002));
                    color = `rgba(${Math.floor(255 * (1 - pulse) + 128 * pulse)}, 0, ${Math.floor(255 * pulse)}, 0.6)`;
                } else if (obj.id === 'plant' && gameState.isTaskComplete) { color = 'rgba(0, 255, 127, 0.7)'; }
                ctx.fillStyle = color; ctx.fillRect(obj.x, obj.y, obj.width, obj.height);
            });
            
            // Draw Ratio Sprite
            const { ratio } = gameState;
            const ratioImg = ratio.direction === 'left' ? ratioImageL : ratioImageR;
            if (ratioImg.complete && ratioImg.naturalWidth !== 0) {
                ctx.drawImage(ratioImg, ratio.x, ratio.y, ratio.width, ratio.height);
            }

            // Draw Player Sprite
            const { player } = gameState;
            if (playerImage.complete && playerImage.naturalWidth !== 0) {
                ctx.drawImage(
                    playerImage,
                    player.frameX * player.spriteWidth,
                    player.frameY * player.spriteHeight,
                    player.spriteWidth,
                    player.spriteHeight,
                    player.x,
                    player.y,
                    player.width,
                    player.height
                );
            }


            drawHud();
            if (gameState.activeDialogue.isActive) drawDialogueBox();
            if (gameState.inPromptBuilderMode) drawPromptBuilder();
        }

        function drawHud() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.6)'; ctx.fillRect(0, 0, canvas.width, 90);
            ctx.fillStyle = '#FFFFFF'; ctx.font = '16px "Roboto Mono"'; ctx.textAlign = 'left';
            ctx.fillText("Objective: Stabilize the Chrono-Bloom", 20, 30);
            ctx.fillText("1. Collect 3 Components.", 20, 55);
            ctx.textAlign = 'right'; ctx.fillText("COMPONENTS:", 780, 30);
            ctx.fillStyle = gameState.collectedComponents.stabilizer ? '#00FFFF' : '#555'; ctx.fillText("[Temporal Freq.]", 780, 55);
            ctx.fillStyle = gameState.collectedComponents.nutrients ? '#4169E1' : '#555'; ctx.fillText("[Nutrient Sol.]", 780, 75);
             ctx.fillStyle = gameState.collectedComponents.light ? '#FFFF00' : '#555'; ctx.fillText("[Lunar Light]", 780, 95);

            if (!gameState.activeDialogue.isActive && !gameState.inPromptBuilderMode) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.6)'; ctx.fillRect(0, canvas.height - 50, canvas.width, 50);
                ctx.textAlign = 'center'; ctx.fillStyle = '#FFFFFF';
                let bottomText = "Use WASD to move.";
                if (gameState.nearbyObject) { bottomText = `Press [E] to interact with ${gameState.nearbyObject.name}`; }
                ctx.fillText(bottomText, canvas.width / 2, canvas.height - 20);
            }
        }

        function drawDialogueBox() {
            const { activeDialogue } = gameState;
            if (activeDialogue.charIndex < activeDialogue.text.length) {
                activeDialogue.charIndex += 1;
            }
            activeDialogue.displayText = activeDialogue.text.substring(0, activeDialogue.charIndex);

            const boxHeight = 180;
            ctx.fillStyle = 'rgba(0, 0, 0, 0.9)'; ctx.strokeStyle = '#FFFFFF'; ctx.lineWidth = 2;
            ctx.fillRect(20, canvas.height - boxHeight - 20, canvas.width - 40, boxHeight);
            ctx.strokeRect(20, canvas.height - boxHeight - 20, canvas.width - 40, boxHeight);

            ctx.fillStyle = '#FFFFFF'; ctx.font = 'bold 20px "Roboto Mono"'; ctx.textAlign = 'left';
            ctx.fillText(activeDialogue.speaker, 40, canvas.height - boxHeight);
            
            ctx.font = '18px "Roboto Mono"';
            const lines = activeDialogue.displayText.split('\n');
            lines.forEach((line, index) => {
                ctx.fillText(line, 45, canvas.height - boxHeight + 40 + (index * 25));
            });

            if (activeDialogue.charIndex >= activeDialogue.text.length) {
                if(activeDialogue.options.length > 0) {
                    activeDialogue.options.forEach((option, index) => {
                        ctx.fillStyle = index === activeDialogue.selectedOption ? '#FFFF00' : '#FFFFFF';
                        ctx.fillText(`${index === activeDialogue.selectedOption ? '>' : ''} ${option.text}`, 400, canvas.height - boxHeight + 60 + (index * 30));
                    });
                } else {
                    ctx.fillText("Press [E] to continue...", canvas.width - 200, canvas.height - 40);
                }
            }
        }

        function drawPromptBuilder() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.8)'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'rgba(60, 60, 60, 1)'; ctx.strokeStyle = '#FFFFFF'; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.rect(150, 200, 500, 400); ctx.fill(); ctx.stroke();
            ctx.fillStyle = '#FFFFFF'; ctx.font = '24px "Roboto Mono"'; ctx.textAlign = 'center';
            ctx.fillText("Prompt Builder", canvas.width / 2, 250);
            ctx.font = '18px "Roboto Mono"'; ctx.textAlign = 'left';
            ctx.fillStyle = '#00FFFF'; ctx.fillText("1. [Temporal Frequency].... LOADED", 200, 320);
            ctx.fillStyle = '#4169E1'; ctx.fillText("2. [Nutrient Solution]..... LOADED", 200, 370);
            ctx.fillStyle = '#FFFF00'; ctx.fillText("3. [Lunar-Cycle Light]..... LOADED", 200, 420);
            ctx.fillStyle = '#FFFFFF'; ctx.font = '20px "Roboto Mono"'; ctx.textAlign = 'center';
            ctx.fillText("Press [Enter] to Confirm & Upload Prompt", canvas.width / 2, 550);
        }

        function gameLoop() {
            update();
            handlePlayerAnimation();
            draw();
            requestAnimationFrame(gameLoop);
        }

        // --- Initialization ---
        function init() {
            if (API_KEY && !API_KEY.includes("...")) {
                try {
                    groq = new Groq({ apiKey: API_KEY, dangerouslyAllowBrowser: true });
                } catch(e) { console.error("Failed to initialize Groq SDK:", e); }
            } else {
                console.warn("API Key missing. BOT-ANY 5000 is offline.");
            }

            let imagesLoaded = 0;
            const totalImages = 4; // background, player, ratio L, ratio R
            const onImageLoad = () => {
                imagesLoaded++;
                if (imagesLoaded === totalImages) {
                    gameLoop();
                }
            };

            backgroundImage.onload = onImageLoad;
            playerImage.onload = onImageLoad;
            ratioImageL.onload = onImageLoad;
            ratioImageR.onload = onImageLoad;

            // Handle potential image loading errors
            playerImage.onerror = () => { console.error("Failed to load assets/start/walking_character_Finn.png"); onImageLoad(); };
            ratioImageL.onerror = () => { console.error("Failed to load assets/start/Ratio_L.png"); onImageLoad(); };
            ratioImageR.onerror = () => { console.error("Failed to load assets/start/Ratio_R.png"); onImageLoad(); };
            backgroundImage.onerror = () => { console.error("Failed to load assets/level1_ecology/ecology_background.png"); onImageLoad(); };
        }

        init();
    </script>
</body>
</html>

